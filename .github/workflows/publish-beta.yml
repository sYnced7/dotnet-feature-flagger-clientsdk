name: Manual Beta Package Publish

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to build (default: detected branch)"
        required: true
        default: ""
      prerelease_suffix:
        description: "Prerelease Suffix (e.g., beta, alpha, rc)"
        required: true
        default: "beta"

env:
  PROJECT_PATH: "src/dotnet-gitlab-feature-flags-clientsdk/FeatureFlagger.clientSdk.csproj"

jobs:
  publish_beta:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      pull-requests: read

    steps:
      - name: 0. Determine branch
        id: resolve_branch
        run: |
          if [ "${{ github.event.inputs.branch }}" != "" ]; then
            echo "branch=${{ github.event.inputs.branch }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.head_ref }}" != "" ]; then
            echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: 1. Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve_branch.outputs.branch }}
          fetch-depth: 0

      - name: 2. Display Context
        run: |
          echo "Selected branch: ${{ steps.resolve_branch.outputs.branch }}"
          echo "Prerelease suffix: ${{ github.event.inputs.prerelease_suffix }}"

      - name: 3. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0"

      - name: 4. Calculate Prerelease Version
        id: semver
        uses: iautom8things/semantic-version@v4.0.5
        continue-on-error: true
        with:
          major_pattern: "^(BREAKING|major|breaking change)"
          minor_pattern: "^(feat|minor|feature)"
          patch_pattern: "^(fix|patch|chore)"
          prerelease_label: ${{ github.event.inputs.prerelease_suffix }}
          version_format: "${major}.${minor}.${patch}-${prerelease_label}.${increment}"

      - name: 5. Validate or Generate Fallback Version
        id: final_version
        run: |
          if [ -z "${{ steps.semver.outputs.version }}" ]; then
            echo "No semantic version generated, creating fallback..."
            fallback="0.0.0-${{ github.event.inputs.prerelease_suffix }}.$(date +%s)"
            echo "version=$fallback" >> $GITHUB_OUTPUT
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "version=${{ steps.semver.outputs.version }}" >> $GITHUB_OUTPUT

            # Semantic version did not increment â†’ no publish
            if [ "${{ steps.semver.outputs.increment }}" == "0" ]; then
              echo "No relevant changes detected â†’ no publish."
              echo "should_publish=false" >> $GITHUB_OUTPUT
            else
              echo "should_publish=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Stop if nothing to publish
        if: steps.final_version.outputs.should_publish == 'false'
        run: |
          echo "Stopping pipeline (no changes)."
          exit 0

      - name: 6. Build and Pack
        id: pack
        run: |
          echo "Using version: ${{ steps.final_version.outputs.version }}"
          dotnet build ${{ env.PROJECT_PATH }} --configuration Release

          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            -o ${{ github.workspace }}/output \
            -p:PackageVersion=${{ steps.final_version.outputs.version }}

      - name: 7. Upload .nupkg Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nuget-package
          path: ${{ github.workspace }}/output/*.nupkg
          retention-days: 7

      - name: 8. Generate Changelog
        id: changelog
        run: |
          echo "### Changes" > changelog.md

          git log -n 20 --pretty=format:"- %s (%h)" >> changelog.md

          echo "log<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 9. Create Git Tag
        run: |
          tag="v${{ steps.final_version.outputs.version }}"
          git tag "$tag"
          git push origin "$tag"

      - name: 10. Create GitHub Release Draft
        id: release
        uses: actions/create-release@v1
        with:
          tag_name: "v${{ steps.final_version.outputs.version }}"
          release_name: "v${{ steps.final_version.outputs.version }}"
          draft: true
          body: ${{ steps.changelog.outputs.log }}

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 11. Upload Package to Release Draft
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/output/*.nupkg
          asset_name: package-${{ steps.final_version.outputs.version }}.nupkg
          asset_content_type: application/zip

      - name: 12. Publish to NuGet
        run: |
          dotnet nuget push ${{ github.workspace }}/output/*.nupkg \
            --source https://api.nuget.org/v3/index.json \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: 13. Summary
        run: |
          echo "## ðŸ§ª Beta Package Published" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.final_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`v${{ steps.final_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Release Draft:** created" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.resolve_branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Changelog:" >> $GITHUB_STEP_SUMMARY
          echo "```\n${{ steps.changelog.outputs.log }}\n```" >> $GITHUB_STEP_SUMMARY
