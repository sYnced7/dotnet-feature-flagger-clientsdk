name:  NuGet Release Pipeline (Beta + Stable)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release: beta or stable"
        required: true
        default: "beta"
        type: choice
        options:
          - beta
          - stable
      branch:
        description: "Branch to build (leave empty for current branch)"
        required: false
        default: ""
      prerelease_suffix:
        description: "Prerelease suffix (e.g., beta, alpha, rc)"
        required: false
        default: "beta"
      override_version:
        description: "Optional manual version override"
        required: false
        default: ""

env:
  PROJECT_PATH: 'src/dotnet-gitlab-feature-flags-clientsdk/FeatureFlagger.clientSdk.csproj'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: 0. Resolve branch
        id: resolve_branch
        run: |
          BRANCH="${GITHUB_REF_NAME:-main}"

          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH="${{ github.event.inputs.branch }}"
          elif [ -n "${GITHUB_HEAD_REF}" ]; then
            BRANCH="${GITHUB_HEAD_REF}"
          fi

          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: 1. Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve_branch.outputs.branch }}
          fetch-depth: 0

      - name: 2. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0'

      - name: 3a. Calculate Semantic Version (beta only)
        id: semver
        if: github.event.inputs.override_version == '' && github.event.inputs.release_type == 'beta'
        uses: iautom8things/semantic-version@v4.0.5
        with:
          major_pattern: '^(BREAKING|major|breaking change)'
          minor_pattern: '^(feat|minor|feature)'
          patch_pattern: '^(fix|patch|chore)'
          prerelease_label: ${{ github.event.inputs.prerelease_suffix }}
          version_format: '${major}.${minor}.${patch}-${prerelease_label}.${increment}'

      - name: 3b. Use manual version override
        id: version_override
        if: github.event.inputs.override_version != ''
        run: echo "version=${{ github.event.inputs.override_version }}" >> $GITHUB_OUTPUT

      - name: 3c. Resolve final version
        id: final_version
        run: |
          OVERRIDE="${{ github.event.inputs.override_version }}"
          SEMVER="${{ steps.semver.outputs.version }}"
          FINAL=""
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"

          if [ -n "$OVERRIDE" ]; then
            FINAL="$OVERRIDE"
          elif [ "$RELEASE_TYPE" == "beta" ] && [ -n "$SEMVER" ]; then
            FINAL="$SEMVER"
          else
            # Stable fallback: YYYY.MM.DD.0
            FINAL=$(date +%Y.%m.%d).0
          fi

          echo "version=$FINAL" >> $GITHUB_OUTPUT
          echo "Resolved version: $FINAL"

      - name: 3d. Check if tag exists
        id: check_tag
        run: |
          tag="v${{ steps.final_version.outputs.version }}"
          exists=$(git ls-remote --tags origin $tag)
          if [ "$exists" != "" ]; then
            echo "Tag $tag already exists. Stopping workflow."
            exit 1
          fi

      - name: 4. Build & Pack NuGet Package
        id: pack
        run: |
          echo "Building version ${{ steps.final_version.outputs.version }}"
          dotnet build ${{ env.PROJECT_PATH }} --configuration Release
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            -o ${{ github.workspace }}/output \
            -p:PackageVersion=${{ steps.final_version.outputs.version }}

      - name: 5. Generate changelog
        id: changelog
        run: |
          if [ "${{ github.event.inputs.release_type }}" == "stable" ]; then
            # Get commits since last stable tag
            LAST_TAG=$(git describe --tags --abbrev=0 --match "v*")
            git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" > changelog.md
          else
            # Beta: commits on current branch since main
            git log origin/main..HEAD --pretty=format:"- %s (%h)" > changelog.md
          fi

          # Encode newlines safely
          changelog=$(awk '{printf "%s\\n",$0}' changelog.md)
          echo "log=$changelog" >> $GITHUB_OUTPUT

      - name: 6. Create Git Tag
        run: |
          tag="v${{ steps.final_version.outputs.version }}"
          git tag $tag
          git push origin $tag

      - name: 7. Create GitHub Release Draft
        id: release
        uses: actions/create-release@v1
        with:
          tag_name: "v${{ steps.final_version.outputs.version }}"
          release_name: "v${{ steps.final_version.outputs.version }}"
          draft: true
          body: ${{ steps.changelog.outputs.log }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 8. Upload .nupkg to Release Draft
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ${{ github.workspace }}/output/FeatureFlagger.ClientSdk.${{ steps.final_version.outputs.version }}.nupkg
          asset_name: FeatureFlagger.ClientSdk.${{ steps.final_version.outputs.version }}.nupkg
          asset_content_type: application/zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 9. Publish to NuGet.org
        run: |
          dotnet nuget push ${{ github.workspace }}/output/*.nupkg \
            --source https://api.nuget.org/v3/index.json \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --skip-duplicate

      - name: 10. Add GitHub Summary
        run: |
          echo "## NuGet Release Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "**Release Type:** \`${{ github.event.inputs.release_type }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ steps.final_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`v${{ steps.final_version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ steps.resolve_branch.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "### Changelog" >> $GITHUB_STEP_SUMMARY
          echo "```\n${{ steps.changelog.outputs.log }}\n```" >> $GITHUB_STEP_SUMMARY
