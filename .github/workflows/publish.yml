name:  Publish NuGet Package

on:
  push:
    branches:
      - main
  
env:
  PROJECT_PATH: 'src/dotnet-gitlab-feature-flags-clientsdk/FeatureFlagger.clientSdk.csproj'

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: 2. Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0' 
          
      - name: 3. Calculate Semantic Version
        id: semver
        uses: iautom8things/semantic-version@v4.0.5 
        with:
          major_pattern: '^(BREAKING|major|breaking change)'
          minor_pattern: '^(feat|minor|feature)'
          patch_pattern: '^(fix|patch|chore)'
          version_format: '${major}.${minor}.${patch}'

      - name: 4. Build and Pack NuGet Package
        id: pack
        run: |
          echo "Calculated Version: ${{ steps.semver.outputs.version }}"
          
          # Restore, Build, and Pack the project
          dotnet build ${{ env.PROJECT_PATH }} --configuration Release
          
          # Use 'dotnet pack' and pass the calculated version as a property
          dotnet pack ${{ env.PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            -o ${{ github.workspace }}/output \
            -p:PackageVersion=${{ steps.semver.outputs.version }}

      - name: 5. Publish to NuGet.org
        if: steps.semver.outputs.version != ''
        run: dotnet nuget push ${{ github.workspace }}/output/*.nupkg \
          --source https://api.nuget.org/v3/index.json \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --skip-duplicate

      - name: 6. Create Git Tag for the New Version
        if: steps.semver.outputs.version != ''
        uses: actions/github-script@v7
        with:
          script: |
            const newVersion = process.env.NEW_VERSION;
            try {
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/tags/v${newVersion}`,
                sha: context.sha
              });
              console.log(`Created tag v${newVersion}`);
            } catch (e) {
              console.log(`Tag v${newVersion} already exists or failed to create.`);
            }
        env:
          NEW_VERSION: ${{ steps.semver.outputs.version }}
